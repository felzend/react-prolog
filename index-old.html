<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	<script type="text/javascript">
		(function($) {
			$(document).ready(function() {
				var SingleStore = { // Single Store Component
					props: ['store'],
					template: `
						<div class="single-store">
							<div v-if="this.$parent.currentStore.length > 0">
									Lista de produtos da loja <b>{{ $parent.currentStore[0].StoreName }}</b>
							</div>
							<div v-else><b>Sem Produtos.</b></div>
							<br>
							<div class="product" v-for="product in $parent.currentStore">
								<img class="img-responsive" v-bind:src="product.ProductPhoto">
								<div class="info">
									<div class="name">{{ product.ProductName }}</div>
									<div class="price"><i class="fas fa-dollar-sign"></i> {{ product.ProductPrice.toFixed(2) }}</div>
									<div class="stock">Estoque: {{ product.ProductAmount }} unidades.</div>
								</div>
								<div class="management">
										<a href="#" class="add-to-cart" v-on:click="$parent.addToCart(product)"><i class="fas fa-plus-circle"></i></a>
								</div>
							</div>
						<div>
						<div class="back">
							<button class="btn btn-info" v-on:click="$parent.exitStore($parent.currentStore.Id)">Voltar</button>
						</div>
					`
				};
				var StoresList = { // Stores List Component
					template: `
						<div class="stores-list">
							<div class="store" v-for="(store, index) in this.$parent.stores.slice(0,15)" v-on:click="$parent.enterStore(store.Id)">
								<div class="thumbnail">
									<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS7d8ZNgzbZWendnubFOmXhir5RX1ZDw4zNdHb16Zc5pTDM_nvVDw">
								</div>
								<div class="info">
									<div class="name">{{ store.Name }}</div>
									<div class="rating"><i class="far fa-star"></i> {{ store.Rating }}</div>
								</div>
							</div>
						</div>
					`,					
				};
				var Cart = {
					props: ['cart'],
					template: `
						<div class="cart">
							{{ cart }}
						</div>
					`
				};
				var app = new Vue({
					el: "#app",
					data: {
						fetchURL: "http://localhost:4000",
						currentView: 'stores-list',
						stores: [],
						
						cart: [],
						currentStore: {},						
					},
					components: {
						'single-store': SingleStore,
						'stores-list': StoresList,
						'cart': Cart,
					},
					methods: {
						addToCart(product) {
							let stock = this.currentStore.filter(p => p.ProductId == product.ProductId);
							if(stock.length > 0) {
								stock = stock[0];
								if(stock.ProductAmount > 0) {
									stock.ProductAmount--;
									this.cart.push(product);
									console.log(product);
								}
							}							
						},
						removeFromCart(product) {
							
						},
						enterStore: function(id) {
							$.get(this.fetchURL.concat(`/stores?id=${id}`), data => {
									this.currentView = 'single-store';
									this.currentStore = data;
							});
						},
						exitStore: function(id) {
							this.currentView = 'stores-list';
						}
					},
					watch: {
						currentStore: function() {
							if(this.currentStore.length > 0) {
								this.currentStore.map(product => {
									if(product.ProductPhoto === undefined || product.ProductPhoto.length == 0) {
										product.ProductPhoto = "http://www.companion-group.com/wp-content/uploads/brands-product-information-200x200.gif";
									}
								});
							}
						},
					},
					mounted: function() {
						//$.get("https://raw.githubusercontent.com/felzend/react-prolog/master/server/assets/foods.json", data => this.foods = JSON.parse(data));
						//$.get("https://raw.githubusercontent.com/felzend/react-prolog/master/server/assets/stores.json", data => this.stores = JSON.parse(data));
						$.get(this.fetchURL.concat("/stores"), data => this.stores = data);
					}
				})
			})
		})(jQuery)
	</script>

	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="./style.css">
	<title>Prolog WebApp</title>
</head>
<body>
<div id="app"> <!-- #app -->
	<nav class="navbar navbar-expand-lg navbar-light" id="navbar">
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
		  <span class="navbar-toggler-icon"></span>
		</button>
	  	<a class="navbar-brand mx-auto" href="#">Prolog WebApp</a>
		<div class="collapse navbar-collapse" id="navbarNav">
			<ul class="navbar-nav mr-auto mt-2 mt-lg-0">
				<li class="nav-item active">
				  <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
				</li>
				<li class="nav-item">
				  <a class="nav-link" href="#">Restaurantes</a>
				</li>
				<li class="nav-item">
				  <a class="nav-link" href="#">Avaliações</a>
				</li>
				<li class="nav-item">
				  <a class="nav-link disabled" href="#">Minha Conta</a>
				</li>
			</ul>
		</div>
		<button class="navbar-toggler" type="button" data-toggle="modal" data-target="#cartModal">
			<i class="fas fa-shopping-cart"></i>
		</button>
	</nav>
	<component :is="currentView"></component>
	<div class="modal" tabindex="-1" role="dialog" id="cartModal"><!-- Cart Modal -->
		<div class="modal-dialog" role="document">
		  <div class="modal-content">
			<div class="modal-header">
			  <h5 class="modal-title">Carrinho de compras</h5>
			  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
			  </button>
			</div>
			<div class="modal-body">
				<cart :cart="cart"></cart>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
			</div>
		  </div>
		</div>
	</div>
</div>
</body>
</html>